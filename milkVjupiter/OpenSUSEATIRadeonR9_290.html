<!doctype html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="generator" content="pandoc">
      <meta name="author" content="Bas Magré">
      <meta name="date" content="2024-10-19">
      
      <title>Milk-V Jupiter OpenSUSE Tumbleweed ATI Radeon R9
290</title>
      <link rel="icon" href="/website-template/favicon.ico">
      <!-- Bootstrap -->
      <link rel="stylesheet" target="_blank" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
      <!-- Font-awesome -->
      <link rel="stylesheet" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <!-- Styles -->
      <link rel="stylesheet" href="/website-template/styles.css">
            <!-- Add favicon here -->
            <!-- Add site-verifications here -->
         </head>
   <body>
            <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
                <!--<a class="navbar-brand" href="#">Navbar</a>-->
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                   <ul class="navbar-nav mr-auto">
                      <li class="nav-item active">
                         <a class="nav-link" href="/index.html">Me <span class="sr-only">(current)</span></a>
                      </li>
                      <!-- <li class="nav-item">
                         <a class="nav-link" href="#">Link</a>
                      </li> -->
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarKODI" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Kodi Addons
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarKODI">
                           <a class="dropdown-item" href="/kodi/npo.html">NPO Uitzending gemist</a>               
                           <a class="dropdown-item" href="/kodi/kanalenlijst-hans.html">De Transponder - Kanalenlijk (Hans)</a>
                           <div class="dropdown-divider"></div>
                           <a class="dropdown-item" href="/kodi/rtlxl.html">(Inactive) RTLxl</a>
                        </div>
                     </li>
                     <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarPi5" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Raspberry Pi 5
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarPi5">
                           <a class="dropdown-item" href="/raspberrypi5/FedoraATIRadeonR9_290.html">Fedora with AMDGPU playing Half Life 2</a>
                        </div>
                     </li>
                     <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarMilkVJ" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Milk-V Jupiter
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarMilkVJ">
                           <a class="dropdown-item" href="/milkVjupiter/OpenSUSEATIRadeonR9_290.html">ATI Radeon R9 290 Kernel 6.1</a>
                           <a class="dropdown-item" href="/milkVjupiter/OpenSUSEATIRadeonHD5850.html">OpenSUSE Tumbleweed ATI Radeon HD 5850 Kernel 6.6</a>
                        </div>
                     </li>
                      <li class="nav-item dropdown">
                         <a class="nav-link dropdown-toggle" href="#" id="navbarSFVF2" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                         Starfive VisionFive 2
                         </a>
                         <div class="dropdown-menu" aria-labelledby="navbarSFVF2">
                            <a class="dropdown-item" href="/starfiveVisionFive2/UbuntuATIRadeonR9_290.html">Ubuntu 22.04 with ATI Radeon R9 290</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/FedoraATIRadeon5450.html">Fedora with ATI Radeon5450</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/UbuntuATIRadeonR9_290_2023_11_20.html">Ubuntu 23.10 with ATI Radeon R9 290</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/OpenSUSEATIRadeonR9_290.html">OpenSUSE Tumbleweed ATI Radeon R9 290</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/OpenSUSEATIRadeonR9_290_mainline.html">OpenSUSE Tumbleweed ATI Radeon R9 290 mainline kernel</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/Ubuntu2410_outofthebox.html">StarFive VisionFive 2 Ubuntu 24.10 AMDGPU</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/Ubuntu2504_outofthebox.html">StarFive VisionFive 2 Ubuntu 25.04 AMDGPU</a>
                            <a class="dropdown-item" href="/starfiveVisionFive2/LiteUBootKernel.html">StarFive VisionFive 2 Lite U-Boot and Kernel</a>
                            <!-- <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a> -->
                         </div>
                      </li>
                      <!-- <li class="nav-item">
                         <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                      </li> -->
                   </ul>
                   <div class="menu-icons">
                     <a class="menu-icon" target="_blank" href="https://github.com/Opvolger" target="_blank"><i class="fa fa-github fa-2x"></i></a>
                     <a class="menu-icon" target="_blank" href="https://www.twitter.com/Opvolger" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>
                     <a class="menu-icon" href="mailto:Opvolger@gmail.com"><i class="fa fa-at fa-2x"></i></a>
                     <a class="menu-icon" target="_blank" href="https://www.linkedin.com/in/bas-magr%C3%A9-67234222/" target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
                     <a class="menu-icon" target="_blank" href="https://www.youtube.com/@justanotherdevopsguy" target="_blank"><i class="fa fa-youtube fa-2x"></i></a>
                     <a class="menu-icon" target="_blank" href="https://www.youtube.com/@opvolger" target="_blank"><i class="fa fa-youtube fa-2x"></i></a>
                  </div>

                   <!-- <form class="form-inline my-2 my-lg-0">
                      <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                      <button class="btn btn-outline-info my-2 my-sm-0" type="submit">Search</button>
                   </form> -->
                </div>
             </nav>
            <div class="container">
         <p class="date">2024-10-19 - Bas Magré</p>
         <!-- <h1 class="title">Milk-V Jupiter OpenSUSE Tumbleweed ATI
Radeon R9 290</h1> -->
                  <div class="row">
            <div class="col-xl-10"><h1
id="milk-v-jupiter---opensuse-tumbleweed-with-external-gpu-ati-radeon-r9-290">Milk-V
Jupiter - OpenSUSE Tumbleweed with external GPU ATI Radeon R9 290</h1>
<h2 id="software">Software</h2>
<p>I used the VisionFive2 image of OpenSUSE Tumbleweed.</p>
<h2 id="hardware">Hardware</h2>
<ul>
<li>Milk-V Jupiter</li>
<li>BEYIMEI PCIE Riser-Ver010X GPU Riser, 1X tot 16X (4PIN/6PIN/MOLEX)
PCIE-verlengkabel, M.2 naar PCI-E Riser Card Bitcoin Litecoin Ethereum.
This is about 11 EURO on amazon, so no big deal… <a
target="_blank" href="https://www.amazon.nl/dp/B0BF4PH83Y?ref_=pe_28126711_487767311_302_E_DDE_dt_1">amazon-link</a></li>
<li>AMD/ATI Hawaii PRO [Radeon R9 290/390], Bought on a Dutch
second-hand website, for 45 EURO. or ATI Radeon 5450, Bought on a Dutch
second-hand website, for 10 EURO.</li>
<li>2x ATX power supply (was still lying around in the house + a new
Cooler Master)</li>
<li>For debugging a USB to TTL (was still lying around in the house), is
about 5 EURO.</li>
</ul>
<h2 id="setup-hardware">Setup (hardware)</h2>
<p>i have had multiple video cards directly in the jupiter.</p>
<ul>
<li>AMD RX 6600 It was detected, but with all firmwares i got a kernel
panic.</li>
<li>NVIDIA GeForce GTX 770, was detected also got to see kernel drivers
with ‘lspci -k’ but didn’t work. (gave no image).</li>
<li>ATI Radeon 5450 works! got in KDE desktop (but was slow)</li>
<li>ATI Radeon R9 290 only works on a Riser board with another power
supply.</li>
</ul>
<p>I have tried everything</p>
<ul>
<li>other power supply.</li>
<li>4x to 16x PCIe converter.</li>
<li>Riser board, but then everything on 1 power supply.</li>
</ul>
<p>I really have no idea why this has to be so complicated, I bought
another 1x to 16x PCIe converter, it will arrive this week. It is
possible that it does not want to work on 2x (mainboard) or with a 4x to
16x PCIe converter. Other video cards did work with the 4x to 16x PCIe
converter in between. We will see. I hope that the 1x to 16x will work
because the Riser board also indirectly goes from 1x to 16x.</p>
<p>hence the somewhat strange setup: <img
src="OpenSUSEATIRadeonR9_290/setup_001.jpeg"
alt="setup Milk-V Jupiter" /></p>
<h2 id="compiling-the-kernel">Compiling the kernel</h2>
<p>I forked the milk-v <a
target="_blank" href="https://github.com/milkv-jupiter/linux-6.1">kernel</a>, updated it
with the <a target="_blank" href="https://gitee.com/bianbu-linux/linux-6.1">Bianbu Linux
- SpacemiT kernel</a>. I was patching myself, but eventually came across
this <a
target="_blank" href="https://gitee.com/bianbu-linux/linux-6.1/pulls/3/commits">pull-request</a>.</p>
<p>I have put all this in my <a
target="_blank" href="https://github.com/Opvolger/spacemit-k1-linux-6.1/tree/bl-v1.0.y-amdgpu">github</a>.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we need some firmwares in the kernel</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone <span class="at">--depth</span> 1 git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git linux-firmware</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we need the kernel</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone <span class="at">--branch</span> bl-v1.0.y-amdgpu https://github.com/Opvolger/spacemit-k1-linux-6.1.git</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> spacemit-k1-linux-6.1</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a .config for compiling the kernel without the onboard GPU and with the AMDGPU enabled.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- k1_extern_gpu_defconfig</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># i have added my GPU firmwares in the config file, maybe you need to edit the `.config` file.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># find the line with CONFIG_EXTRA_FIRMWARE= and add you firmwares. i have a amdgpu/hawaii so search the kernel source code with the text `amdgpu/hawaii` and you will see all the *.bin files that are needed. or look in dir `linux-firmware/amdgpu/`.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># build the kernel, i have 16 cores, so change it if you have more (or less).</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- <span class="at">-j</span> 16</span></code></pre></div>
<p>I have coped the root and boot partition of OpenSUSE to my m2 drive.
boot is on my m2 partition 5 and root is partition 7.</p>
<p>The kernel will be here: <code>arch/riscv/boot/Image.gz</code> and
dtb file here
<code>arch/riscv/boot/dts/spacemit/m1-x_milkv-jupiter.dtb</code>.</p>
<p>Copy them to the OpenSUSE boot partition. Check the name of the
initramfs, in my case it is <code>initramfs-6.6.36+.img</code>. It’s not
a problem that it’s a different version, we included the firmware in our
kernel anyway.</p>
<p>boot the milk-v with a serial connection. it will stop booting
(u-boot is missing the standard files it expects. We have the OpenSUSE
partitions which are organized differently than it expects).</p>
<p>51af1d3a-4696-4dfc-b8ca-93c85b140f1e == UUID of the root partition of
OpenSUSE on my m2 drive.</p>
<p>boot the kernel from u-boot:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="va">ramdisk_addr_r</span><span class="op">=</span>0x21000000</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="va">fdt_addr_r</span><span class="op">=</span>0x31000000</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> nvme 0:5 <span class="va">${kernel_addr_r}</span> /Image.gz</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> nvme 0:5 <span class="va">${fdt_addr_r}</span> /m1-x_milkv-jupiter.dtb</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> nvme 0:5 <span class="va">${ramdisk_addr_r}</span> /initramfs-6.6.36+.img</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">setenv</span> bootargs <span class="st">&#39;console=ttyS0,115200 root=UUID=51af1d3a-4696-4dfc-b8ca-93c85b140f1e rootfstype=ext4 rootwait rw earlycon clk_ignore_unused loglevel=7 radeon.pcie_gen2=0 swiotlb=131072 stmmaceth=chain_mode:1 selinux=0&#39;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">booti</span> <span class="va">$kernel_addr_r</span> <span class="va">$ramdisk_addr_r</span>:<span class="va">$filesize</span> <span class="va">$fdt_addr_r</span></span></code></pre></div>
<p>You can make it shorter, create on your one pc the file:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode boot.chtml"><code class="sourceCode dosbat"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ramdisk_addr_r=0x21000000</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>fdt_addr_r=0x31000000</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>load nvme 0:5 ${kernel_addr_r} <span class="at">/Image</span>.gz</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>load nvme 0:5 ${fdt_addr_r} <span class="at">/m1-x_milkv-jupiter</span>.dtb</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>load nvme 0:5 ${ramdisk_addr_r} <span class="at">/initramfs-6</span>.6.36+.img</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>setenv bootargs &#39;console=ttyS0,115200 root=UUID=51af1d3a<span class="at">-4696-4dfc-b8ca-93c85b140f1e</span> rootfstype=ext4 rootwait rw earlycon clk_ignore_unused loglevel=7 radeon.pcie_gen2=0 swiotlb=131072 stmmaceth=chain_mode:1 selinux=0&#39;</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>booti $kernel_addr_r $ramdisk_addr_r:$filesize $fdt_addr_r</span></code></pre></div>
<p>create a boot.source:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo mkimage <span class="at">-C</span> none <span class="at">-A</span> riscv <span class="at">-T</span> script <span class="at">-d</span> boot.cmd boot.scr</span></code></pre></div>
<p>copy the file boot.scr to the OpenSUSE boot partition.</p>
<p>The next time you can boot in u-boot with</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> nvme 0:5 <span class="va">${scriptaddr}</span> boot.scr<span class="kw">;</span> <span class="bu">source</span> <span class="va">${scriptaddr}</span></span></code></pre></div></div>
            <div class="d-none d-xl-block col-xl-2 bd-toc">
               <ul class="section-nav">
                  <li class="toc-entry"><ul>
<li><a
href="#milk-v-jupiter---opensuse-tumbleweed-with-external-gpu-ati-radeon-r9-290"
id="toc-milk-v-jupiter---opensuse-tumbleweed-with-external-gpu-ati-radeon-r9-290">Milk-V
Jupiter - OpenSUSE Tumbleweed with external GPU ATI Radeon R9 290</a>
<ul>
<li><a href="#software" id="toc-software">Software</a></li>
<li><a href="#hardware" id="toc-hardware">Hardware</a></li>
<li><a href="#setup-hardware" id="toc-setup-hardware">Setup
(hardware)</a></li>
<li><a href="#compiling-the-kernel"
id="toc-compiling-the-kernel">Compiling the kernel</a></li>
</ul></li>
</ul></li>
               </ul>
            </div>
         </div>
               </div>
            <!-- Add comment hosting service here -->
            <!-- Footer -->
            <footer class="footer text-muted">
                <div align="center">
                   <!-- Update licences -->
                   Content is available under <a target="_blank" href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank" rel="noopener">CC BY-SA 3.0</a>
                   &nbsp;|&nbsp;
                   Sourcecode licensed under <a target="_blank" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank" rel="noopener">GPL-3.0</a>
                   <br />
                   <!-- Please keep the following line -->
                   Built with <a target="_blank" href="https://www.pandoc.org" target="_blank" rel="noopener">Pandoc</a> 
                   using <a target="_blank" href="https://github.com/ashki23/pandoc-bootstrap" target="_blank" rel="noopener">pandoc-bootstrap</a> theme
                   <br />
                   <!-- Update copyright -->
                   Copyright, Bas Magr&eacute;
                </div>
             </footer>
             <!-- Add global site tag (gtag.js) and site analytics here -->
            <!-- JS, Popper.js, and jQuery -->
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
      <!-- Mathjax -->
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script>
         /* Bootstrap styles to tables */
         function bootstrapStylePandocTables() {
         $('tr.header').parent('thead').parent('table').addClass('table table-condensed'); }
         $(document).ready(function () { bootstrapStylePandocTables(); });
         /* Adjust the height when click the toc */
         var shiftWindow = function() { scrollBy(0, -60) };
         window.addEventListener("hashchange", shiftWindow);
         function load() { if (window.location.hash) shiftWindow(); }
      </script>
   </body>
</html>